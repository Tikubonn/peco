# Peco

| 日本語 | [English](README.md) |

PecoはPythonで書かれたHTML向けの軽量のテンプレートエンジンです。
このテンプレートエンジンはレンダリングされていない状態であってもページのレイアウトを崩さないよう 、
幾つかの制御構文がコメントの形態をしています。

```html
<!DOCTYPE html>
<html>
  <head>
    <title>$title</title>
  </head>
  <body>
    <!-- @for post in posts -->
      <!-- @if post.publish -->
        <h1>$post.title</h1>
        @sanitize $post.about
      <!-- @endif -->
    <!-- @endfor -->
  </body>
</html>
```

## インストール方法

`setup.py`が同梱されているので下記のコマンドを実行してください。

```sh
python setup.py install
```

## ライブラリとして呼び出す

`peco.parser`パッケージが公開している`parse()`と`parse_string()`関数を利用することで、テンプレートオブジェクトを受け取ることができます。
テンプレートオブジェクトは`.render()`と`.render_string()`メソッドを持っており、これらのメソッドを呼び出すことでテンプレートにパラメータを埋め込むことができます。
詳細は`help()`関数、またはソースコードをお読みください。

```python
from peco.parser import parse, parse_string

template = parse_string("Hello, $name!")
template.render_string(name = "tikubonn") ## Hello, tikubonn!
```

## コマンドラインから呼び出す

Pecoはインストール後に下記のように呼び出すことができます。

```shell
peco --parameter '{"person": {"name": "tikubonn"}}'
```

```shell
peco 'input.html' --parameter-file 'parameter.json' --output-file 'output.html'
```

```shell
python -m peco 'input.html' --parameter-file 'parameter.json' --output-file 'output.html'
```

対応している引数は下記のとおりです。

| 引数 | 概要 |
| ---- | ---- |
| `入力ファイル` | 入力元のファイルを指定します。形式は問いませんが、Pecoの文法に従っている必要があります。未指定の場合には標準入力が使用されます。 |
| `--output-file` `-o` | 出力先のファイルを指定します。形式は問いませんが、Pecoの文法に従っている必要があります。未指定の場合には標準出力が使用されます。 | 
| `--parameter-file` | 埋め込むパラメータを含んだ`.json`形式のファイルです。ここに定義されている値がテンプレートの各所に埋め込まれます。未指定の場合には空の連想配列が使用されます。| 
| `--parameter` | `.json`形式の埋め込むパラメータです。未指定の場合には空の連想配列が使用されます。`--parameter-file`と同時に指定した場合の動作は未定義です。 |
| `--version` `-v` | コマンドのバージョン情報を出力後に終了します。 |
| `--help` `-h` | コマンドのヘルプ情報を出力後に終了します。 |

## 文法の紹介

### 予約文字のエスケープ

Pecoではパラメータの埋め込みや展開を制御する構文に`$`と`@`文字を使用します。
そのため、それらの文字を何も考えずに使用すると思わぬ結果を招くかもしれません。
それを避けるため、Pecoではこれらの文字を二つ並べることによって展開時にエスケープする機能があります。

```html
$$ <!-- 展開時に$になる -->
@@ <!-- 展開時に@になる -->
$$$$ <!-- 展開時に$$になる -->
@@@@ <!-- 展開時に@@になる -->
```

### パラメーターの埋め込み

`$`の後に続けて名前を書くことで、レンダリング時にその場所に対応する値を埋め込みます。
パラメータ名に利用できる文字は「大小合わせた英字とアンダーバー」のみになります。

```html
$name
$age
```

### パラメータの要素へのアクセス

パラメータ名の後、`.`の後に続けて名前を書くことで、パラメータの要素を埋め込みます。
要素名に使用できる文字はパラメータ名と同様です。

```html
$person.name
$person.age
```

### 条件分岐

`@if`制御文はパラメータの状態に合わせて対応するコンテンツを展開します。
`@else`節は不要であれば省略することができます。
Pecoの条件分岐は単純な真偽値の判定しか行えないため、初期状態では比較などの演算には対応していません。
演算の機能が必要であればPecoに演算子を追加する必要があります。

```html
<input value="@if $value true @else true @endif">
```

もしHTMLの要素を展開したい場合には、
下記のようにブロックの制御構文を使用することを推奨いたします。
こちらのほうが非レンダリング時にも、レイアウトが崩れることがないためです。

```html
<!-- @if $value -->
  <div>
    true
  </div>
<!-- @else -->
  <div>
    false
  </div>
<!-- @endif -->
```

### 繰り返し

パラメータの各要素を指定されたパラメータ名に割り当てながら、中のコンテンツを繰り返し展開します。
Pythonの`for`文のように要素を複数の変数に分配する機能にはまだ未対応ですが、将来的に実装するかもしれません。

```html
<input value="@for $element in $iter $element @endfor">
```

こちらも`@if`制御文と同様にブロック形式の制御構文に対応しています。

```html
<!-- @for $element in $iter -->
  $element
<!-- @endfor -->
```

## フィルタの紹介

フィルタは与えられたデータを変換する役割を持ちます。
基本的にはいままで紹介した制御構文などとほとんど同じですが、
これらは入れ子にすることによって、変換結果を伝搬させることができます。
下の例では、個人のあだ名の一覧をカンマで連結したあとに、前後の空白を削除し、最終的にサニタイズしています。

```html
@sanitize @trim @join , $person.nicknames
```

### 要素の連結

`@join`フィルタは任意の区切り文字とパラメータを受け取り、
その場所にパラメータの各要素を区切り文字で連結したテキストを展開します。
フィルタの直後にパラメータの参照がある場合には、区切り文字なしの連結が行われます。
区切り文字は通常のテキストを想定しているため、`@for`等の制御構文を与えた場合の動作は未定義です。

```html
<meta name="keywords" content="@join , $keywords">
```

```html
<meta name="keywords" content="@join $keywords"> <!-- 区切り文字なしの連結 -->
```

### トリミング

`@trim`フィルタはパラメータを展開する際に前後の空白を削除してくれます。

```html
@trim $value
```

### サニタイズ

`@sanitize`フィルタはパラメータを展開する際にテキストをHTML向けにサニタイズします。

```html
@sanitize $value
```

## ライセンス

PecoはMITライセンスで公開されています。  
詳細は同梱されている[LICENSE](LICENSE)をご参照ください。
